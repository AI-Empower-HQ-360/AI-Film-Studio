name: CI/CD - GitHub Pages Deployment

on:
  push:
    branches: [main, dev, staging]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read
  checks: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================
  # BACKEND TESTS (Python)
  # ==========================================
  backend-test:
    name: ðŸ Backend Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=html --ignore=tests/integration --ignore=tests/e2e
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: htmlcov/

  # ==========================================
  # FRONTEND LINT & TEST
  # ==========================================
  frontend-lint:
    name: ðŸ” Frontend Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run ESLint
        working-directory: frontend
        run: npm run lint || true

      - name: Type check
        working-directory: frontend
        run: npx tsc --noEmit || true

  # ==========================================
  # BUILD FRONTEND
  # ==========================================
  build:
    name: ðŸ—ï¸ Build Frontend
    runs-on: ubuntu-latest
    needs: [frontend-lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Next.js app
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ vars.API_URL || 'https://api.ai-film-studio.com' }}
          NEXT_PUBLIC_APP_NAME: 'AI Film Studio'
          NEXT_PUBLIC_APP_VERSION: ${{ github.sha }}
        run: |
          npm run build
          touch out/.nojekyll

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/out
          retention-days: 7

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/out

  # ==========================================
  # DEPLOY TO GITHUB PAGES
  # ==========================================
  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [build, backend-test]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ¬ AI Film Studio Deployed! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # NOTIFY ON FAILURE
  # ==========================================
  notify-failure:
    name: ðŸ“¢ Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Deployment Failed - ${context.sha.substring(0, 7)}`;
            const body = `
            ## Deployment Failure Report
            
            **Workflow**: ${context.workflow}
            **Run ID**: ${context.runId}
            **Commit**: ${context.sha}
            **Branch**: ${context.ref}
            **Actor**: ${context.actor}
            
            [View Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'bug', 'automated']
            });
